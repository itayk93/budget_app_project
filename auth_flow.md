# Authentication and Authorization Flow

The application implements a robust authentication and authorization system using JWTs (JSON Web Tokens) for session management, `bcrypt` for secure password handling, and email verification for user account integrity. Supabase is utilized for user data storage and management.

## 1. User Registration

-   **Endpoint:** `POST /auth/register` (or `netlify/functions/auth-register.js`)
-   **Process:**
    1.  User provides `username`, `email`, `password`, `firstName`, and `lastName`.
    2.  Input validation ensures all required fields are present.
    3.  The system checks for existing users with the same email or username to prevent duplicates.
    4.  If unique, the user's password is **hashed using `bcrypt`** and stored in the `users` table (managed by Supabase). The `email_verified` flag is initially set to `false`.
    5.  A unique **email verification token** is generated by `TokenService`.
    6.  `EmailService` sends a welcome email and a separate email containing the verification link (with the token) to the user's registered email address.
    7.  A JWT is generated for the newly registered user and returned to the client, along with a message prompting email verification.

## 2. Email Verification

-   **Endpoint:** `POST /auth/verify-email`
-   **Process:**
    1.  The user clicks the verification link in the email, which directs them to this endpoint with the `token`.
    2.  `TokenService` verifies the authenticity and expiry of the provided token.
    3.  If the token is valid, the corresponding user's `email_verified` status in the `users` table is updated to `true`.

## 3. User Login

-   **Endpoint:** `POST /auth/login` (or `netlify/functions/auth-login.js`)
-   **Process:**
    1.  User provides `email` (or `username`) and `password`.
    2.  The system retrieves the user record from the `users` table.
    3.  The provided password is **compared against the stored `password_hash` using `bcrypt.compare`**.
    4.  If credentials are valid:
        -   The system checks if `email_verified` is `true`. If not, login is rejected, and the user is prompted to verify their email.
        -   A **JWT** is generated, containing `userId`, `email`, and `username`. This token is signed with `process.env.JWT_SECRET` and typically expires in 24 hours.
        -   The user's `last_login` timestamp in the database is updated.
        -   The generated JWT and essential user details are returned to the client.

## 4. Authentication Middleware (`authenticateToken`)

-   **Purpose:** Secures API routes by ensuring only authenticated users can access them.
-   **Process:**
    1.  It expects a JWT in the `Authorization` header (e.g., `Bearer <token>`).
    2.  The token is extracted and **verified using `jwt.verify`** with the application's `JWT_SECRET`.
    3.  If the token is valid, the `userId` (and other claims) from the token payload are used to fetch the complete user object from the database (`SupabaseService.getUserById`).
    4.  The fetched user object is attached to `req.user`, making user information available to subsequent route handlers.
    5.  **Demo User Handling:** A special case exists for "demo" users (`userId: 'demo-user-001'`) which allows them to bypass full database lookup for efficiency.
    6.  If the token is missing, invalid, or expired, the request is rejected with a `401 Unauthorized` or `403 Forbidden` status.

## 5. Optional Authentication Middleware (`optionalAuth`)

-   **Purpose:** Allows routes to optionally receive user information if a valid token is present, but does not block access if no token is provided or if it's invalid.
-   **Process:** Similar to `authenticateToken`, but if authentication fails, `req.user` is simply not set, and the request proceeds.

## 6. Password Management

-   **Forgot Password (`POST /auth/forgot-password`):**
    1.  User provides their email.
    2.  A password reset token is generated by `TokenService` and sent to the user's email via `EmailService`.
    3.  For security, the response does not indicate whether the email exists in the system.
-   **Reset Password (`POST /auth/reset-password`):**
    1.  User provides the reset `token` and a `newPassword`.
    2.  The token is verified by `TokenService`.
    3.  If valid, the user's password in the database is updated (hashed with `bcrypt`).
    4.  A password change confirmation email is sent via `EmailService`.
-   **Change Password (`POST /auth/change-password`):**
    1.  (Requires authentication via `authenticateToken`).
    2.  User provides `currentPassword` and `newPassword`.
    3.  The `currentPassword` is verified against the stored hash.
    4.  If correct, the user's password is updated (hashed).
    5.  A confirmation email is sent.

## 7. Email Change Workflow

-   **Initiate Email Change (`PUT /auth/profile`):**
    1.  (Requires authentication).
    2.  If a user attempts to change their email address, the system does not update it immediately.
    3.  Instead, an email change verification token is generated (`TokenService`).
    4.  A verification email is sent to the *new* email address.
-   **Verify Email Change (`POST /auth/verify-email-change`):**
    1.  The user clicks the link in the email sent to the new address, providing the `token`.
    2.  The token is verified.
    3.  If valid, the user's email address in the database is updated to the new email, and `email_verified` is set to `true` for the new email.

## Key Components and Services

-   **`SupabaseService`:** Interacts with the Supabase backend for user data (create, retrieve, update, verify password).
-   **`EmailService`:** Handles sending various transactional emails (welcome, verification, password reset, password change confirmation, email change verification).
-   **`TokenService`:** Manages the generation and verification of JWTs for email verification, password reset, and email change.
-   **`bcryptjs`:** Used for secure one-way hashing of passwords.
-   **`jsonwebtoken`:** Used for creating, signing, and verifying JWTs.
