# פיצר יעדים חודשיים למערכת ניהול תקציב

## סקירה כללית
מערכת יעדים חודשיים מתקדמת שמאפשרת למשתמשים להגדיר יעדי הוצאה חודשיים לכל קטגוריה, עם חישוב אוטומטי של ממוצעים היסטוריים ועדכון דינמי עם מעבר החודשים.

## תכונות עיקריות

### 🎯 הגדרת יעדים חודשיים
- **יעד אוטומטי**: חישוב יעד על בסיס ממוצע של 3 החודשים האחרונים
- **יעד ידני**: אפשרות לערוך ידנית את היעד החודשי
- **אפשרויות חישוב מתקדמות**: ממוצע של 3 או 12 חודשים
- **לוגיקה חכמה**: רק חודשים עם נתונים נכללים בחישוב (אם יש נתונים רק לחודש אחד - הממוצע יהיה של חודש אחד, לא חלוקה ב-3)

### 📊 תצוגה ויזואלית
- **תצוגה בכרטיס קטגוריה**: יעד חודשי מוצג באופן ברור בחלק העליון של כל כרטיס קטגוריה
- **פס התקדמות צבעוני**:
  - 🟢 ירוק: עד 80% מהיעד
  - 🟡 כתום: 80%-100% מהיעד  
  - 🔴 אדום: מעל 100% (חריגה מהיעד)
- **מידע מפורט**: הצגת הוצאה נוכחית מול יעד, כמה נשאר או כמה חרגנו
- **כפתור עריכה מהיר**: אייקון עריכה ליד כל יעד לשינוי מהיר

### 🗓️ יעדים שבועיים
- **חישוב פרופורציונלי**: לקטגוריות עם `weekly_display = true`
- **יעד שבועי מחושב**: באופן יחסי לפי מספר הימים בשבוע מתוך החודש
- **תצוגה מותאמת**: "יעד שבועי" במקום "יעד חודשי"
- **הסבר ברור**: הערה המסבירה שהיעד השבועי מבוסס על היעד החודשי
- **לא ניתן לעריכה**: יעדים שבועיים מחושבים אוטומטי - רק היעד החודשי ניתן לעריכה

### 📝 מודל עריכת יעדים
- **ממשק אינטואיטיבי**: מודל פתיחה נוח לעריכת יעדים
- **עריכה ידנית**: שדה קלט לעריכת הסכום החדש
- **כפתורי חישוב מהיר**: 
  - "ממוצע 3 חודשים אחרונים"
  - "ממוצע 12 חודשים אחרונים"
- **גרף היסטוגרמה**: הצגה ויזואלית של הוצאות ב-12 החודשים האחרונים
- **אימות נתונים**: בדיקה שהסכום תקין וחיובי

### 📈 גרף היסטוגרמה
- **מודל נפרד**: פתיחת מודל מיוחד להצגת ההיסטוגרמה
- **נתונים היסטוריים**: 12 החודשים האחרונים
- **עיצוב רספונסיבי**: מתאים לכל גדלי מסך
- **צבעים אינטואיטיביים**: גרדיאנט כחול, אפקט hover
- **פרטים מלאים**: הצגת חודש, שנה, וסכום בכל עמודה

## 🔄 עדכון אוטומטי עם מעבר חודש

### התנהגות עם תחילת חודש חדש
כאשר משתמש נכנס לראשונה למערכת ביום הראשון של חודש חדש, המערכת מבצעת עדכון אוטומטי:

1. **זיהוי חודש חדש**: בדיקה אם המשתמש נכנס לראשונה בחודש החדש
2. **חישוב יעדים מחדש**: עבור כל קטגוריה של המשתמש:
   - חישוב ממוצע 3 חודשים חדש (כולל את החודש שהסתיים)
   - עדכון הערך בטבלה `category_order`
3. **עדכון מותנה**: רק קטגוריות שיש להן נתוני הוצאה מעודכנות
4. **משתמש ספציפי**: העדכון מתבצע רק עבור המשתמש הנוכחי

### לוגיקת העדכון
```
דוגמה: כניסה ב-1 באוגוסט 2025

חישוב חדש יתבסס על:
- מאי 2025 (3 חודשים אחורה)
- יוני 2025 (2 חודשים אחורה)  
- יולי 2025 (חודש אחרון שהסתיים)

אם אחד מהחודשים ללא נתונים - לא נכלל בחישוב
```

### מועד הביצוע
- **כניסה ראשונה בחודש**: רק בכניסה הראשונה של המשתמש לחודש החדש
- **סימון ביצוע**: שמירה של מועד העדכון האחרון למניעת עדכונים כפולים
- **פעולה שקטה**: העדכון מתרחש ברקע ללא הפרעה לחוויית המשתמש

### מימוש טכני
```javascript
// בדיקה אוטומטית בעמוד הדשבורד
useEffect(() => {
  const checkAndRefreshTargets = async () => {
    const shouldRefreshResponse = await categoriesAPI.shouldRefreshTargets();
    
    if (shouldRefreshResponse.should_refresh) {
      const refreshResponse = await categoriesAPI.refreshMonthlyTargets();
      if (refreshResponse.updated) {
        // רענון הנתונים בדשבורד
        refetchDashboard();
      }
    }
  };
  
  if (selectedCashFlow) {
    checkAndRefreshTargets();
  }
}, [selectedCashFlow]);
```

### שמירת מצב העדכון
המערכת שומרת ב-`users.monthly_targets_last_update` את תאריך העדכון האחרון:
- **פורמט**: `YYYY-MM-01` (תמיד היום הראשון בחודש)
- **השוואה**: בדיקה אם התאריך הנוכחי גדול מהתאריך השמור
- **עדכון**: רק אם עבר חודש שלם מהעדכון האחרון

## 🗄️ מבנה בסיס הנתונים

### עמודה חדשה: `monthly_target`
```sql
ALTER TABLE category_order 
ADD COLUMN monthly_target DECIMAL(10,2) DEFAULT NULL;
```

**פרטים טכניים**:
- **סוג**: DECIMAL(10,2) - עד 99,999,999.99
- **ברירת מחדל**: NULL (אין יעד)
- **עדכון**: אוטומטי או ידני
- **אינדקס**: לביצועים מהירים

### טריגר עדכון אוטומטי
```sql
CREATE TRIGGER update_category_order_updated_at_trigger
    BEFORE UPDATE ON category_order
    FOR EACH ROW
    EXECUTE FUNCTION update_category_order_updated_at();
```

**מטרה**: עדכון השדה `updated_at` בכל פעם שמשנים יעד חודשי

## 🔌 API נקודות קצה

### חישוב יעד אוטומטי
```
POST /api/categories/calculate-monthly-target
Body: { category_name: "קטגוריה", months: 3 }
```

### עדכון יעד ידני
```
POST /api/categories/update-monthly-target  
Body: { category_name: "קטגוריה", monthly_target: 500.0 }
```

### שליפת הוצאות נוכחיות
```
GET /api/categories/monthly-spending/{categoryName}
Response: { current_spending: 250.0, month: 7, year: 2025 }
```

### היסטוריית הוצאות
```
GET /api/categories/spending-history/{categoryName}?months=12
Response: { spending_history: [...] }
```

## 💾 קבצי SQL לביצוע

### 1. הוספת העמודה החדשה
`sql/add_monthly_target_column.sql` - הוספת עמודת `monthly_target` לטבלה

### 2. הוספת עמודת מעקב עדכונים
`sql/add_monthly_targets_last_update_column.sql` - הוספת עמודה לטבלת משתמשים למעקב אחר עדכונים

### 3. אתחול יעדים קיימים  
`sql/initialize_monthly_targets.sql` - חישוב ואתחול יעדים עבור קטגוריות קיימות

## 🎨 עיצוב ו-UX

### צבעי המערכת
- **ירוק (#28a745)**: יעד תקין, עד 80%
- **כתום (#ffc107)**: אזהרה, 80%-100%  
- **אדום (#dc3545)**: חריגה מהיעד

### רספונסיביות
- **דסקטופ**: תצוגה מלאה עם כל הפרטים
- **מובייל**: תצוגה מותאמת, גרף מתכווץ
- **טאבלט**: תצוגה בינונית

### נגישות
- **ניגודיות גבוהה**: בין טקסט לרקע
- **כפתורים גדולים**: קלים ללחיצה
- **תוויות ברורות**: הסבר מה כל אלמנט עושה

## 🔧 התקנה והפעלה

### שלב 1: עדכון בסיס הנתונים
```sql
-- הרצת הקבצים בסדר:
\i sql/add_monthly_target_column.sql
\i sql/initialize_monthly_targets.sql  
```

### שלב 2: אתחול השרת
```bash
# השרת יכיר את השדות החדשים אוטומטית
npm start
```

### שלב 3: ממשק המשתמש
הקומפוננטים החדשים נכללים כבר בקוד ויתחילו לעבוד אוטומטית

## 🔍 בדיקות ואבטחה

### בדיקות אוטומטיות
- **ולידציה**: בדיקת סכומים חיוביים בלבד
- **אימות משתמש**: רק המשתמש יכול לערוך את היעדים שלו
- **הגנה על SQL Injection**: שימוש ב-prepared statements

### ביצועים
- **אינדקסים**: למהירות שאילתות
- **קאש**: תוצאות חישובים נשמרות זמנית
- **עדכון חכם**: רק כשיש שינוי אמיתי

## 🚀 תכונות עתידיות

### שלב ב'
- **התראות**: הודעה כשמתקרבים ליעד
- **יעדים שנתיים**: בנוסף לחודשיים
- **השוואות**: לחודש קודם או לשנה שעברה
- **ייצוא נתונים**: CSV/Excel של יעדים וביצועים

### שלב ג'
- **למידת מכונה**: חיזוי יעדים על בסיס התנהגות
- **יעדים קבוצתיים**: למשפחות או זוגות
- **אינטגרציה עם יומן**: תזכורות חכמות
- **גרפים מתקדמים**: מגמות וחיזוי עתידי

---

## 📝 הערות מיוחדות

### חישוב יעדים שבועיים
```javascript
// דוגמה לחישוב יעד שבועי:
const weeklyTarget = (monthlyTarget * daysInCurrentWeek) / totalDaysInMonth;

// אם החודש בן 30 יום והשבוע בן 7 ימים:
// יעד שבועי = (1000 * 7) / 30 = 233.33 ש"ח
```

### טיפול בחודשים ללא נתונים
המערכת מתעלמת מחודשים ללא הוצאות בחישוב המותים, כך שהממוצע מדויק ומשקף את ההוצאה האמיתית.

### אופטימיזציות ביצועים
- שליפת נתונים רק לחודש הנוכחי
- שמיחה קאש של חישובי ממוצעים
- עדכון אסינכרוני ברקע