# אפיון מסך בדיקת עסקאות לפני העלאה

## 1. סקירה כללית

מטרת מסך זה היא לאפשר למשתמשים לבדוק, לנקות, לקטלג ולאמת עסקאות שנטענו מקובץ חיצוני (למשל, אקסל מבנק או חברת אשראי) לפני שהן נשמרות באופן סופי במערכת. תהליך זה חיוני למניעת כפילויות, סינון עסקאות לא רלוונטיות (מעסקים מוסתרים), ותיקון נתונים שגויים, ובכך מבטיח את איכות ודיוק המידע הפיננסי של המשתמש.

## 2. נקודת כניסה ותהליך עבודה

תהליך העבודה מורכב משני שלבים עיקריים, המבטיחים שהעסקאות לא יאבדו ומאפשרים למשתמש גמישות.

**שלב א': העלאת קובץ ועיבוד ראשוני**
1.  המשתמש נכנס לעמוד `/upload` ובוחר קובץ עסקאות (למשל, קובץ אקסל).
2.  לאחר בחירת הקובץ, המערכת מעבדת אותו ברקע (באופן אסינכרוני).
3.  העסקאות שחולצו מהקובץ נשמרות בטבלה זמנית בשם `pending_transactions` עם סטטוס "ממתין לאישור". שלב זה מבטיח שהנתונים הגולמיים נשמרים גם אם המשתמש סוגר את הדפדפן.

**שלב ב': בדיקה ואישור העסקאות**
1.  בממשק הראשי (למשל, בלוח הבקרה או בעמוד ההעלאה), תוצג למשתמש חלונית או כפתור בולט עם הכיתוב **"טען עסקאות ממתינות לאישור"**, המציין שיש עסקאות שמחכות לבדיקה.
2.  לחיצה על כפתור זה מובילה למסך "בדיקת עסקאות לפני העלאה".
3.  המסך שולף את כל העסקאות של המשתמש מטבלת `pending_transactions` ומציג אותן למשתמש לבדיקה, עריכה ואישור.

## 3. רכיבי ממשק והיגיון עסקי

### 3.1. סיכום נתונים (Header)

חלק זה מספק סיכום כמותי של העסקאות שנטענו מאזור ההמתנה:

-   **סה״כ עסקאות:** המספר הכולל של רשומות שנטענו מטבלת `pending_transactions`.
-   **כפילויות:** מספר העסקאות שזוהו ככפולות פוטנציאליות לעסקאות שכבר קיימות בטבלה הסופית (`transactions`).
-   **עסקים מוסתרים:** מספר העסקאות המשויכות לעסקים שהמשתמש הגדיר כ"מוסתרים".
-   **נמחקו:** מונה של עסקאות שהמשתמש סימן למחיקה ידנית מהקבוצה הנוכחית. מתחיל ב-0.
-   **יועלו:** המספר הכולל של עסקאות שנטענו.

### 3.2. פקדים וסינון

-   **תזרים יעד:**
    -   **סוג:** Dropdown.
    -   **לוגיקה:** מאפשר למשתמש לבחור לאיזה "תזרים" (חשבון) לשייך את העסקאות החדשות. הרשימה תכיל את כל התזרימים המוגדרים בחשבון המשתמש. הבחירה תשפיע על כל העסקאות שיאושרו להעלאה.
-   **הסתר כפילויות ועסקים מוסתרים:**
    -   **סוג:** Checkbox.
    -   **לוגיקה:** בסימון, מסנן את הטבלה ומסתיר את כל השורות שסומנו כ"כפילות" או "עסק מוסתר". הכיתוב ליד התיבה יציג באופן דינמי את סך העסקאות שיוסתרו.
-   **מתאריך:**
    -   **סוג:** Date Picker.
    -   **לוגיקה:** מסנן את הטבלה ומציג רק עסקאות שהתאריך שלהן מאוחר או שווה לתאריך שנבחר.
-   **איפוס:**
    -   **סוג:** כפתור.
    -   **לוגיקה:** מאפס את כלל המסננים למצבם ההתחלתי.

### 3.3. טבלת העסקאות

הטבלה מציגה את כל העסקאות מטבלת `pending_transactions`, עם יכולות עריכה ופעולה עבור כל שורה.

| עמודה | תיאור | לוגיקה והתנהגות |
| :--- | :--- | :--- |
| **תאריך** | תאריך ביצוע העסקה. | ניתן לעריכה. |
| **שם העסק** | שם בית העסק כפי שזוהה בקובץ. | ניתן לעריכה (שדה טקסט). |
| **סטטוס** | אייקון או תווית המציינים את סטטוס העסקה. | - **כפול:** מסמן עסקה שזוהתה ככפילות.<br>- **עסק מוסתר:** מסמן עסקה ששייכת לעסק מוסתר.<br>- **🚫 (רגיל):** עסקה תקינה להעלאה. |
| **סכום** | סכום העסקה. | - מציג את הסכום המקורי ואת המטבע מהקובץ.<br>- אם המטבע שונה ממטבע ברירת המחדל של המשתמש, יוצג אייקון המרה (🔄) והסכום יחושב ויוצג במטבע המקומי. |
| **קטגוריה** | קטגוריה חשבונאית. | - **סוג:** Dropdown.<br>- **לוגיקה:** הרשימה מכילה את כל הקטגוריות של המשתמש. המערכת יכולה להציע קטגוריה אוטומטית על בסיס עסקאות קודמות עם אותו בית עסק. |
| **הערות** | שדה טקסט להוספת הערות אישיות. | ניתן לעריכה. |
| **עדכן** | כפתור לשמירת שינויים בשורה. | - **התנהגות:** הכפתור הופך לפעיל כאשר המשתמש מבצע שינוי באחד מהשדות בשורה. לחיצה עליו שומרת את השינויים במצב המקומי של הרשימה. |
| **פעולות** | כפתורים לפעולות נוספות. | - **✂️ (פיצול):** פותח מודאל או ממשק בתוך השורה המאפשר לפצל עסקה אחת למספר עסקאות קטנות יותר.<br>- **🗑️ (מחיקה):** מסמן את השורה למחיקה. השורה תופיע בצבע אפור/עם קו חוצה, ומונה ה"נמחקו" יתעדכן. לחיצה נוספת תבטל את המחיקה. |

### 3.4. פעולות תחתונות (Footer)

-   **ביטול:**
    -   **סוג:** כפתור.
    -   **לוגיקה:** מוחק את כל העסקאות של המשתמש מהטבלה הזמנית `pending_transactions` ומחזיר את המשתמש לעמוד הראשי. פעולה זו מבטלת את כל תהליך ההעלאה הנוכחי.
-   **אשר והעלה X עסקאות:**
    -   **סוג:** כפתור (פעולה ראשית).
    -   **לוגיקה:**
        -   הכיתוב על הכפתור מתעדכן דינמית ומציג את המספר הסופי של עסקאות שיעלו בפועל.
        -   בלחיצה, המערכת מבצעת את הפעולות הבאות:
            1.  שולחת לשרת את רשימת העסקאות המאושרות (לאחר עריכה, וללא אלו שסומנו למחיקה/כפולות/מוסתרות).
            2.  השרת מעביר את העסקאות המאושרות מטבלת `pending_transactions` לטבלה הסופית `transactions`.
            3.  העסקאות שעברו בהצלחה נמחקות מטבלת `pending_transactions`.
            4.  אם חלק מהעסקאות לא עברו (למשל, עקב שגיאה), הן יישארו בטבלת ההמתנה לבדיקה חוזרת.

## 4. לוגיקה מרכזית (Core Logic)

### 4.1. זיהוי כפילויות

זיהוי כפילות יתבצע על ידי השוואת כל עסקה מ`pending_transactions` מול העסקאות הקיימות בטבלה הסופית `transactions`. עסקה תסומן ככפילות אם מתקיימים התנאים הבאים:
1.  **שם עסק** זהה או דומה מאוד.
2.  **סכום** זהה.
3.  **תאריך** זהה או קרוב מאוד (טווח של +/- 3 ימים).

### 4.2. זיהוי עסקים מוסתרים

המערכת תשווה את שם העסק של כל עסקה מול רשימת "העסקים המוסתרים" שהוגדרה על ידי המשתמש. אם תימצא התאמה, העסקה תסומן בהתאם.

### 4.3. ניהול מצב (State Management)

הממשק הקדמי (Frontend) ינהל את מצב כל העסקאות ברשימה. עבור כל עסקה, יישמרו הנתונים המקוריים מהטבלה הזמנית, הנתונים לאחר עריכת המשתמש, והסטטוס שלה (רגילה, כפולה, מוסתרת, מסומנת למחיקה).

### 4.4. העלאה סופית (API Call)

בלחיצה על כפתור האישור, תתבצע קריאת API לנקודת קצה (למשל, `/api/transactions/process-pending`). קריאה זו תפעיל את הלוגיקה בצד השרת להעברת הנתונים בין הטבלאות.

## 5. סיפורי משתמש (User Stories)

-   **כמשתמש,** אני רוצה שתהליך העלאת הקובץ יהיה אמין, כך שגם אם אסגור את החלון, הנתונים לא יאבדו.
-   **כמשתמש,** אני רוצה לקבל חיווי ברור כשיש עסקאות שממתינות לאישור שלי.
-   **כמשתמש,** אני רוצה לבדוק את כל העסקאות הממתינות במקום אחד, כדי שאוכל לוודא את דיוקן לפני שהן נכנסות למערכת.
-   **כמשתמש,** אני רוצה שהמערכת תזהה ותסמן לי עסקאות כפולות באופן אוטומטי.
-   **כמשתמש,** אני רוצה לבטל את כל קבוצת העסקאות הממתינות אם החלטתי שאני לא רוצה להעלות אותן.

## 6. שאלות פתוחות והנחות

-   **המרה למט"ח:** מה המקור לחישוב שערי המט"ח? האם מתבצעת קריאת API חיצונית בזמן אמת, או שהחישוב מבוסס על שער יציג קבוע?
-   **עריכת עסקה כפולה:** מה קורה אם משתמש עורך עסקה שסומנה כ"כפילות"? האם היא עדיין נחשבת כפילות ויש להתעלם ממנה, או שהעריכה הופכת אותה לעסקה חדשה ולגיטימית?
-   **אפיון פיצול (✂️):** יש לכתוב אפיון מפורט לממשק והלוגיקה של פיצול עסקה.
-   **ביצועים:** כיצד המערכת תתמודד עם כמויות גדולות של עסקאות ממתינות?
-   **טיפול בשגיאות:** מה קורה אם העברת עסקה בודדת מהטבלה הזמנית לסופית נכשלת? האם כל האצווה (batch) מתבטלת, או שהעסקה הבעייתית נשארת להמשך טיפול? (האפיון מניח שהיא נשארת).

## 7. מבנה נתונים (Supabase Tables)

כדי לממש את הלוגיקה המתוארת, המערכת תשתמש בטבלאות הבאות.

### 7.1. טבלאות מקור (Source Tables)

אלו הטבלאות שמהן המערכת שולפת נתונים לצורך הצגת המידע ובדיקתו.

#### 7.1.1. `pending_transactions` (טבלת המקור הראשית למסך)
טבלה זו היא "אזור ההמתנה" (staging area) של העסקאות. היא המקור הראשי לנתונים המוצגים במסך הבדיקה.

| שם עמודה | סוג נתונים | תיאור |
| :--- | :--- | :--- |
| `id` | `uuid` | מזהה ייחודי של הרשומה. |
| `user_id` | `uuid` | מזהה המשתמש (מפתח זר לטבלת `auth.users`). |
| `raw_date` | `text` | התאריך הגולמי כפי שנקרא מהקובץ. |
| `raw_business_name` | `text` | שם העסק הגולמי מהקובץ. |
| `raw_amount` | `text` | הסכום הגולמי מהקובץ. |
| `status` | `text` | סטטוס הרשומה (למשל, `awaiting_review`). |
| `source_file` | `text` | שם הקובץ המקורי שממנו יובאה העסקה. |

#### 7.1.2. `transactions`
טבלה זו משמשת לבדיקת כפילויות מול עסקאות שכבר אושרו בעבר.

| שם עמודה | סוג נתונים | תיאור |
| :--- | :--- | :--- |
| `user_id` | `uuid` | מזהה המשתמש. |
| `business_name` | `text` | שם בית העסק. |
| `date` | `date` | תאריך ביצוע העסקה. |
| `amount` | `numeric` | סכום העסקה. |

#### 7.1.3. `hidden_businesses`
טבלה זו מכילה את רשימת בתי העסק שהמשתמש בחר להסתיר באופן קבוע.

| שם עמודה | סוג נתונים | תיאור |
| :--- | :--- | :--- |
| `user_id` | `uuid` | מזהה המשתמש (מפתח זר לטבלת `auth.users`). |
| `name` | `text` | שם בית העסק להסתרה. |

#### 7.1.4. `categories`
טבלה זו מספקת את רשימת הקטגוריות האפשריות לבחירה ב-Dropdown.

| שם עמודה | סוג נתונים | תיאור |
| :--- | :--- | :--- |
| `user_id` | `uuid` | מזהה המשתמש (מפתח זר לטבלת `auth.users`). |
| `name` | `text` | שם הקטגוריה. |
| `id` | `uuid` | מזהה ייחודי של הקטגוריה. |

#### 7.1.5. `cashflows`
טבלה זו מספקת את רשימת התזרימים (חשבונות) של המשתמש לבחירה ב-Dropdown של "תזרים יעד".

| שם עמודה | סוג נתונים | תיאור |
| :--- | :--- | :--- |
| `user_id` | `uuid` | מזהה המשתמש (מפתח זר לטבלת `auth.users`). |
| `name` | `text` | שם התזרים. |
| `id` | `uuid` | מזהה ייחודי של התזרים. |

### 7.2. טבלת יעד (Target Table)

זוהי הטבלה הסופית שאליה יועברו העסקאות לאחר שיאושרו על ידי המשתמש.

#### 7.2.1. `transactions`

| שם עמודה | סוג נתונים | תיאור |
| :--- | :--- | :--- |
| `id` | `uuid` | מזהה ייחודי של הרשומה (מפתח ראשי). |
| `created_at` | `timestampz` | חותמת זמן של מועד יצירת הרשומה. |
| `user_id` | `uuid` | מזהה המשתמש (מפתח זר לטבלת `auth.users`). |
| `date` | `date` | תאריך ביצוע העסקה, כפי שהוזן/אושר על ידי המשתמש. |
| `business_name` | `text` | שם בית העסק, כפי שהוזן/אושר על ידי המשתמש. |
| `amount` | `numeric` | סכום העסקה הסופי. ערך חיובי להכנסה, שלילי להוצאה. |
| `currency` | `text` | קוד המטבע של העסקה (למשל, "ILS", "USD"). |
| `category_id` | `uuid` | מזהה הקטגוריה שנבחרה (מפתח זר לטבלת `categories`). |
| `cashflow_id` | `uuid` | מזהה התזרים שאליו שויכה העסקה (מפתח זר לטבלת `cashflows`). |
| `notes` | `text` | הערות שהוסיף המשתמש. |
| `source_file` | `text` | (אופציונלי) שם הקובץ המקורי שממנו יובאה העסקה, לצורכי מעקב. |